@(dbname: String, query: String, innerHtml: String, allObjs: Set[Long], dataSets: Seq[PerObjData])

@main("Per Object: "+ query.replace("/", " vs. ")) {

    <ul class="largehint">
        <li><a class="largehint" href='@routes.PerClassController.query(dbname, query)'>Per-class analysis of current objects.</a></li>
        <li><a class="largehint" href='@routes.PerAllocationSiteController.query(dbname, query)'>Per-allocation-site analysis of current objects.</a></li>
        <li><a class="largehint" href='@routes.TimingController.query(dbname, query)'>Lifetime analysis of current objects.</a></li>
        <li><a class="largehint" href='@routes.PerObjController.perobj(dbname, s"Not($query)")'>Not(..) - Negate current query.</a></li>
        <li><a class="largehint" href='@routes.PerObjController.perobj(dbname, s"Deeply($query)")'>Deeply(..) - Deep query.</a></li>
        <li><a class="largehint" href='@routes.PerObjController.perobj(dbname, s"ReachableFrom($query)")'>ReachableFrom(..) - All objects reachable from current objects.</a></li>
        <li><a class="largehint" href='@routes.PerObjController.perobj(dbname, s"CanReach($query)")'>CanReach(..) - All objects that can reach the current objects.</a></li>
    </ul>

    <style>
    .result rect.matched {
        fill: steelblue;
    }

    rect.rest {
        fill: #d9d9d9;
    }
    </style>

    <h1>Per Object: @query</h1>

    <script>
            var COMMAND = "query";
            var DBNAME  = "@dbname";
            var QUERIES = [@Html(dataSets.map("'"+_.query+"'").mkString(", "))];
    </script>

    <div class="resultMain">
        <h2>Comparison Matrix</h2>

        <svg class="result"></svg>
        <div class="log" width="500" height="200"></div>

        <script>
                var color = randomColor({count: @(dataSets.size), seed: 123});

                function getRawData(focusMatch, focusNonmatch) {
                    var queries = [];
                    var sizes = [];
                    var data = [];
                    var undata = [];
                    var i = 0;
                    var f = 0;

                    @for(dataSet <- dataSets) {
                    queries.push("@(dataSet.query)");
                    data.push([@(dataSet.data.map(_.oid).mkString(","))]);
                    undata.push([@((allObjs -- dataSet.data.map(_.oid)).mkString(","))]);
                    console.log({
                        q: '@dataSet.query',
                        nallObjs: @(allObjs.size),
                        ndataSet: @(dataSet.data.size),
                        nUndata: @((allObjs -- dataSet.data.map(_.oid)).size)
                    });
                    }

                    var hiddenObjs = new Set([]);

                    console.log("focusMatch=");
                    console.log(focusMatch);
                    for (i of focusMatch) {
                        console.log(i);
                        console.log("focus: adding "+undata[i].length+" oids to hiddenObjs");
                        for (f in undata[i]) {
                            hiddenObjs.add(undata[i][f]);
                        }
                    }

                    console.log("focusNonmatch=");
                    console.log(focusNonmatch);
                    for (i of focusNonmatch) {
                        console.log(i);
                        console.log("hide: adding "+data[i].length+" oids to hiddenObjs");
                        for (f in data[i]) {
                            hiddenObjs.add(data[i][f]);
                        }
                    }

                    console.log("hiddenObjs:");
                    console.log(hiddenObjs);

                    for (i in data) {
                        data[i] = data[i].filter(function (oid) {
                            return !hiddenObjs.has(oid);
                        });
                    }

                    for (i in data) {
                        var size_row = [];
                        for (j in data) {
                            var jSet = new Set(data[j]);
                            size_row.push(data[i].filter(function (oid) {
                                return jSet.has(oid);
                            }).length);
                        }
                        sizes.push(size_row);
                    }

                    return {
                        sizes: sizes,
                        queries: queries,
                        data: data,
                        totalFocused: @allObjs.size - hiddenObjs.size
                    };
                }

                const boxSize = 100;
                var i;
                var includeMatchList = new Set([]);
                var hideMatchList = new Set([]);

                var data;

                const N = @dataSets.size;
                const margin = {top: 0, bottom: 100, left: 200, right: 0};
                const svg = d3.select("svg")
                        .attr("width", (N+1)*boxSize+margin.left+margin.right)
                        .attr("height", (N+1)*boxSize+margin.bottom+margin.top);
                const grid = svg.append("g")
                        .attr("transform", "translate("+margin.left+","+margin.top+")")
                        .attr("width", +svg.attr("width")-margin.left-margin.right)
                        .attr("height", +svg.attr("height")-margin.top-margin.bottom);

                draw();

                // legend:
                for (i in data.queries) {
                    var l = svg.append("text")
                            .attr("transform", "translate("+(margin.left+i*boxSize+boxSize/2)+","+(margin.top + boxSize*N+margin.bottom/2)+") rotate(-20)")
                            .attr("text-anchor", "middle")
                            .attr("class", "legend"+i)
                            .attr("dx", "0.35em")
                            .text(data.queries[i]);
                    l.on("mouseover", mouseOverHandlerX(i));
                    l.on("mouseout",  mouseOutHandler(i,i));
                    l = svg.append("text")
                            .attr("transform", "translate("+margin.left+","+(margin.top+i*boxSize+boxSize/2)+")")
                            .attr("text-anchor", "end")
                            .attr("class", "legend"+i)
                            .attr("dy", "0.35em")
                            .text(data.queries[i]);
                    l.on("mouseover", mouseOverHandlerY(i));
                    l.on("mouseout",  mouseOutHandler(i,i));
                }

                function draw() {
                    data = getRawData(includeMatchList, hideMatchList);
//                console.log({data});

                    grid.selectAll(".gridCell").remove();

                    var gridData = [];

                    for (i in data.sizes) {
                        for (j in data.sizes) {
                            gridData.push({
                                i: i,
                                j: j,
                                size: data.sizes[i][j]
                            });
                        }
                    }

//                console.log({gridData});

                    const maxSize = data.totalFocused;

                    const sz = d3.scaleLinear()
                            .domain([0, maxSize])
                            .range([0, boxSize - 10]);

                    var cells = grid.selectAll("g")
                            .data(gridData)
                            .enter()
                            .append("g")
                            .attr("class", "gridCell");

                    cells.attr("transform", function (d) {
                        return "translate("+(d.i*boxSize)+","+(d.j*boxSize)+")";
                    });

                    cells.append("rect")
                            .attr("class", "rest")
                            .attr("width",  boxSize - 10)
                            .attr("height", boxSize - 10);

                    cells.append("rect")
                            .attr("height", function(d) {return boxSize - 10; })
                            .attr("width", function(d) {return sz(d.size); })
                            .attr("class", function(d) {
                                return "matched objectsRectX"+d.i+" objectsRectY"+d.j;
                            })
                            .text("bar");

                    cells.on("click", function (d) {
                        console.log("clicked:");
                        console.log(d);
                        if (includeMatchList.has(d.i)) {
                            includeMatchList.delete(d.i);
                            hideMatchList.add(d.i);
                            $(".legend"+(d.i)).css("fill", "#d9d9d9");
                        } else if (hideMatchList.has(d.i)) {
                            hideMatchList.delete(d.i);
                            $(".legend"+d.i).css("fill", "black");
                        } else {
                            includeMatchList.add(d.i);
                            $(".legend"+d.i).css("fill", "steelblue");
                        }

                        if (d != j) {
                            if (includeMatchList.has(d.j)) {
                                includeMatchList.delete(d.j);
                                hideMatchList.add(d.j);
                                $(".legend"+(d.j)).css("fill", "#d9d9d9");
                            } else if (hideMatchList.has(d.j)) {
                                hideMatchList.delete(d.j);
                                $(".legend"+d.j).css("fill", "black");
                            } else {
                                includeMatchList.add(d.j);
                                $(".legend"+d.j).css("fill", "steelblue");
                            }
                        }
//                                    if (includeMatchList.has(j)) {
//                                        includeMatchList.delete(j);
//                                        hideMatchList.add(j);
//                                    } else if (hideMatchList.has(j)) {
//                                        hideMatchList.delete(j);
//                                    } else {
//                                        includeMatchList.add(j);
//                                    }
                        console.log(includeMatchList);
                        console.log(hideMatchList);
                        draw();
                    });

                }
                function mouseOverHandlerX(i) {
                    return function() {
                        $(".matched").css("fill", "C0C0C0");
                        $(".objectsRectX"+i).css("fill", "#5AA7E6");
                    }
                }

                function mouseOverHandlerY(i) {
                    return function() {
                        $(".matched").css("fill", "C0C0C0");
                        $(".objectsRectY"+i).css("fill", "#5AA7E6");
                    }
                }

                function mouseOutHandler(i,j) {
                    return function() {
                        $(".matched").css("fill", "steelblue");
                    }
                }
        </script>
        <div class="dataSetsContainer">
        @for(dataSet <- dataSets) {
            <div class="result" style="overflow-y: scroll; height: 100%;">
                <h2>@dataSet.query</h2>
                <table id="resultTable@dataSet.query" class="tablesorter">
                    <thead>
                        <tr>
                            <th>Obj. ID</th>
                            <th>Class</th>
                            <th>Allocation Site</th>
                        </tr>
                    </thead>
                    <tbody>
                        @for(dataItem <- dataSet.data.take(1000/dataSets.size)) {
                            <tr>
                                <td><span class="oid">@dataItem.oid</span></td>
                                <td>@Html(dataItem.klass.map("<span class='klassname'>"+_+"</span>").getOrElse("<span class='empty'>N/A</span>"))</td>
                                <td>@Html(dataItem.allocationSite.map("<span class='allocationsite'>"+_+"</span>").getOrElse("<span class='empty'>N/A</span>"))</td>
                            </tr>
                        }
                        @if(dataSet.data.size > 1000/dataSets.size) {
                            <tr>
                                <td>...</td>
                                <td>...</td>
                                <td>...</td>
                                <td>...</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
        </div>
    </div>
        <!--div class="result" style="overflow-y: scroll; height: 100%;">

        <table id="resultTable" class="tablesorter selectable">
            <thead>
                <tr>
                    <th></th>
                    <th>Obj. ID</th>
                    <th>Class</th>
                    <th>Allocation Site</th>
                </tr>
            </thead>
            <tbody>
                ...
            </tbody>
        </table>
    </div-->
        <!--input type="submit" value="Select objects"/-->
}
